---
import { property } from "../data/property";
import { pointsOfInterest, categoryConfig } from "../data/locations";
import Mountain from "@lucide/astro/icons/mountain";
import Building2 from "@lucide/astro/icons/building-2";
import Flag from "@lucide/astro/icons/flag";
import X from "@lucide/astro/icons/x";
import { cloudinaryUrl } from "../lib/cloudinary";

const { city, region } = property.location.address;

// Serialize POI data for client-side JS
const poiData = pointsOfInterest.map((poi) => ({
  ...poi,
  imageUrl: cloudinaryUrl(poi.imageId),
  categoryLabel: categoryConfig[poi.category].label,
  categoryBgLight: categoryConfig[poi.category].bgLight,
  categoryTextDark: categoryConfig[poi.category].textDark,
  markerColor: categoryConfig[poi.category].color,
}));
---

<section id="location" class="bg-neutral-50 py-16 sm:py-24">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="text-center">
      <h2
        class="text-3xl font-bold tracking-tight text-neutral-900 sm:text-4xl"
      >
        Location & Nearby
      </h2>
      <p class="mx-auto mt-4 max-w-2xl text-lg text-neutral-600">
        {city}, {region} â€” Ski-in at Fernie Alpine Resort with easy access to downtown
      </p>
    </div>

    <!-- Legend -->
    <div class="mt-8 flex flex-wrap justify-center gap-4">
      {
        Object.entries(categoryConfig).map(([key, config]) => (
          <div class="flex items-center gap-2 text-sm text-neutral-600">
            <span
              class="h-3 w-3 rounded-full"
              style={`background: ${config.color}`}
            />
            <span>{config.label}</span>
          </div>
        ))
      }
    </div>

    <!-- Map Container -->
    <div class="mt-8 overflow-hidden rounded-2xl shadow-lg">
      <div id="fernie-map" style="height: 500px; width: 100%;"></div>
    </div>
  </div>
</section>

<!-- Location Dialog -->
<dialog
  id="location-dialog"
  class="fixed inset-0 m-auto w-full max-w-lg rounded-2xl p-0 backdrop:bg-black/60"
>
  <div class="relative">
    <img id="dialog-image" src="" alt="" class="h-56 w-full object-cover" />
    <button
      id="dialog-close"
      class="absolute right-3 top-3 flex h-8 w-8 items-center justify-center rounded-full bg-black/50 text-white transition hover:bg-black/70"
      aria-label="Close"
    >
      <X size={18} />
    </button>
  </div>
  <div class="p-6">
    <h3 id="dialog-title" class="text-xl font-semibold text-neutral-900"></h3>
    <p id="dialog-description" class="mt-2 text-neutral-600"></p>
    <span
      id="dialog-category"
      class="mt-4 inline-block rounded px-3 py-1 text-xs font-medium uppercase tracking-wide"
    ></span>
  </div>
</dialog>

<!-- Leaflet CSS & JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
></script>

<style is:global>
  /* Hide default Leaflet controls */
  .leaflet-control-zoom,
  .leaflet-control-attribution {
    display: none !important;
  }

  /* Droplet marker shape */
  .droplet-marker {
    position: relative;
    width: 36px;
    height: 46px;
    cursor: pointer;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }

  .droplet-marker svg.droplet-shape {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .droplet-marker .marker-icon {
    position: absolute;
    top: 9px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
  }

  /* Dialog styling */
  dialog::backdrop {
    background: rgba(0, 0, 0, 0.6);
  }

  dialog[open] {
    animation: dialog-in 0.2s ease-out;
  }

  @keyframes dialog-in {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
</style>

<script is:inline define:vars={{ poiData }}>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize map with interactions disabled
    const map = L.map("fernie-map", {
      zoomControl: false,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      touchZoom: false,
      boxZoom: false,
      keyboard: false,
      dragging: false,
    });

    // Add tile layer
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "",
    }).addTo(map);

    // Dialog elements
    const dialog = document.getElementById("location-dialog");
    const dialogImage = document.getElementById("dialog-image");
    const dialogTitle = document.getElementById("dialog-title");
    const dialogDescription = document.getElementById("dialog-description");
    const dialogCategory = document.getElementById("dialog-category");
    const dialogClose = document.getElementById("dialog-close");

    // Close dialog handlers
    dialogClose.addEventListener("click", () => dialog.close());
    dialog.addEventListener("click", (e) => {
      if (e.target === dialog) {
        dialog.close();
      }
    });

    // Lucide icon SVG paths (from lucide.dev)
    const iconPaths = {
      House:
        '<path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>',
      Mountain:
        '<path d="m8 3 4 8 5-5 5 15H2L8 3z"/><path d="M4.14 15.08c2.62-1.57 5.24-1.43 7.86.42 2.74 1.94 5.49 2 8.23.19"/>',
      Building2:
        '<path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/>',
      Beer: '<path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M9 12v6"/><path d="M13 12v6"/><path d="M14 7.5c-1 0-1.44.5-3 .5s-2-.5-3-.5-1.72.5-2.5.5a2.5 2.5 0 0 1 0-5c.78 0 1.57.5 2.5.5S9.44 3 11 3s2 .5 3 .5 1.72-.5 2.5-.5a2.5 2.5 0 0 1 0 5c-.78 0-1.5-.5-2.5-.5Z"/><path d="M5 8v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8"/>',
      UtensilsCrossed:
        '<path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8"/><path d="M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Zm0 0 7 7"/><path d="m2.1 21.8 6.4-6.3"/><path d="m19 5-7 7"/>',
      TreePine:
        '<path d="m17 14 3 3.3a1 1 0 0 1-.7 1.7H4.7a1 1 0 0 1-.7-1.7L7 14h-.3a1 1 0 0 1-.7-1.7L9 9h-.2A1 1 0 0 1 8 7.3L12 3l4 4.3a1 1 0 0 1-.8 1.7H15l3 3.3a1 1 0 0 1-.7 1.7H17Z"/><path d="M12 22v-3"/>',
      Waves:
        '<path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>',
      Flag: '<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/>',
      Landmark:
        '<line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/>',
      Bike: '<circle cx="18.5" cy="17.5" r="3.5"/><circle cx="5.5" cy="17.5" r="3.5"/><circle cx="15" cy="5" r="1"/><path d="M12 17.5V14l-3-3 4-3 2 3h2"/>',
      Snowflake:
        '<line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/><path d="m20 16-4-4 4-4"/><path d="m4 8 4 4-4 4"/><path d="m16 4-4 4-4-4"/><path d="m8 20 4-4 4 4"/>',
    };

    // Create icon SVG
    function createIconSvg(iconName) {
      const paths = iconPaths[iconName];
      if (!paths) {
        return "";
      }
      return `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">${paths}</svg>`;
    }

    // Create droplet SVG (point at bottom)
    function createDropletSvg(color) {
      return `
        <svg class="droplet-shape" viewBox="0 0 36 46" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 46C18 46 36 29.5 36 19C36 8.5 27.94 2 18 2C8.06 2 0 8.5 0 19C0 29.5 18 46 18 46Z" fill="${color}"/>
          <path d="M18 44C18 44 34 28.5 34 19C34 9.5 26.84 4 18 4C9.16 4 2 9.5 2 19C2 28.5 18 44 18 44Z" fill="${color}" stroke="white" stroke-width="2"/>
        </svg>
      `;
    }

    // Add markers
    poiData.forEach((poi) => {
      // Create custom droplet icon with embedded SVG icon
      const markerHtml = `
        <div class="droplet-marker">
          ${createDropletSvg(poi.markerColor)}
          <div class="marker-icon">${createIconSvg(poi.icon)}</div>
        </div>
      `;

      const icon = L.divIcon({
        html: markerHtml,
        className: "",
        iconSize: [36, 46],
        iconAnchor: [18, 46],
      });

      // Create marker
      const marker = L.marker([poi.lat, poi.lng], { icon }).addTo(map);

      // Click handler opens dialog
      marker.on("click", () => {
        dialogImage.src = poi.imageUrl;
        dialogImage.alt = poi.name;
        dialogTitle.textContent = poi.name;
        dialogDescription.textContent = poi.description;
        dialogCategory.textContent = poi.categoryLabel;
        dialogCategory.style.background = poi.categoryBgLight;
        dialogCategory.style.color = poi.categoryTextDark;
        dialog.showModal();
      });
    });

    // Fit bounds to show all markers
    const bounds = L.latLngBounds(poiData.map((poi) => [poi.lat, poi.lng]));
    map.fitBounds(bounds, { padding: [10, 10] });
  });
</script>
